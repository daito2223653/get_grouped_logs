#!/usr/bin/env bash

# Copyright Bosch Software Innovations GmbH, 2016.
# Part of the SW360 Portal Project.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Eclipse Public License v1.0
# which accompanies this distribution, and is available at
# http://www.eclipse.org/legal/epl-v10.html

help() {
    echo "call this entrypointscript as:"
    echo "    $0 -h      : to see this help"
    echo "    $0 server  : to run the cve-search web server"
    echo "    $0 updater : to run cron and keep the cve-search db up to date (needed for inital population of the DB)"
    echo " or as usual: $0 SOME ARBITRARY COMMAND"
    echo
    echo "the used / parsed environmental variables are:"
    echo "  for connecting to related servers"
    echo "    \$REDIS_HOST (defaults to: default configuration of cve-search)"
    echo "    \$MONGODB_HOST (defaults to: default configuration of cve-search)"
    echo
    echo "  for enabling debugging"
    echo "    \$DEBUG (defaults to: False)"
}

if [[ $# = 1 && "$1" == "-h" ]]; then
    help
    exit 0
fi

################################################################################
set -e

sed -i 's/Host: Debug: True/Debug: '"${DEBUG:-False}"'/' etc/configuration.ini
[[ "$REDIS_HOST" ]] && {
    sed -i '0,/Host: localhost/s//Host: '"$REDIS_HOST"'/' etc/configuration.ini

    [[ "$MONGODB_HOST" ]] && {
        sed -i '0,/Host: localhost/s//Host: '"$MONGODB_HOST"'/' etc/configuration.ini
    } || echo "set \$REDIS_HOST to connect to a custom mongodb server"

} || echo "set \$REDIS_HOST to connect to a custom redis server"

################################################################################
if [[ $# = 1 && "$1" == "updater" ]]; then
    exec 5>&1
    DB_MGMT_OUT=$(sbin/db_mgmt.py -p | tee >(cat - >&5))
    if [[ ! "$DB_MGMT_OUT" == "database already populated" ]]; then
        python3 /cve-search/sbin/db_mgmt_cpe_dictionary.py
    fi

    exec python3 /cve-search/sbin/db_updater.py -l -c -v
fi

################################################################################
if [[ $# = 1 && "$1" == "server" ]]; then
    exec python3 /cve-search/web/index.py
fi

################################################################################
exec "$@"


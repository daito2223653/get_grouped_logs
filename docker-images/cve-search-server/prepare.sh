#!/usr/bin/env bash

# Copyright Bosch Software Innovations GmbH, 2016.
# Part of the SW360 Portal Project.
#
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Eclipse Public License v1.0
# which accompanies this distribution, and is available at
# http://www.eclipse.org/legal/epl-v10.html

set -ex
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )" && pwd )"
COMMIT_REF="4c165eff1af0e4c7bdf103c341203717ae677f64"
TARGET="cve-search@$COMMIT_REF.tar.gz"

if [ ! -f "$DIR/$TARGET" ]; then
    TMP=$(mktemp -d ${TMPDIR:-/tmp}/tmp.XXXXXXX)
    env $(grep -v '^#' "$DIR/../proxy.env" | xargs) \
        git clone --branch master https://github.com/cve-search/cve-search "$TMP/cve-search.git"
    cd "$TMP/cve-search.git"
    git archive $COMMIT_REF | gzip >"$DIR/$TARGET"
    rm -rf "$TMP"
    # wget --header="Accept:application/vnd.github.v3.raw" \
    #      -O - \
    #      https://api.github.com/repos/cve-search/cve-search/tarball/$COMMIT_REF > "$DIR/$TARGET"
else
    echo "... the file $TARGET already exists: skip"
fi
